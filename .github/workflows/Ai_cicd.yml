on:
  pull_request:
    types: [opened, synchronize]

# æ·»åŠ é€™å€‹æ¬Šé™å€å¡Š
permissions:
  contents: read
  pull-requests: write  # é€™ä½¿å·¥ä½œæµç¨‹å¯ä»¥è©•è«– PR

jobs:
  ai_test_suggestion:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"  # å¯ä¾éœ€æ±‚èª¿æ•´ Python ç‰ˆæœ¬
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-generativeai pyyaml requests
          
      - name: Get PR Details
        id: pr_details
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "PR_TITLE=$(gh pr view ${{ github.event.pull_request.number }} --json title -q .title)" >> $GITHUB_ENV
          echo "PR_BODY=$(gh pr view ${{ github.event.pull_request.number }} --json body -q .body)" >> $GITHUB_ENV
      
      - name: Create script directory and data directory
        run: |
          mkdir -p .github/scripts
          mkdir -p .github/data
      
      - name: Create test tags file
        run: |
          cat > .github/data/test_tags.yaml << 'EOF'
          tags:
            - livestream
            - settings
            - following
            - login
            - register
            - profile
            - notification
            - search
            - feed
            - comment
            - upload
            - dashboard
            - payment
            - subscription
            - messaging
          EOF
      
      - name: Create AI script
        run: |
          cat > .github/scripts/Ai_run.py << 'EOF'
          import os
          import sys
          import yaml
          import google.generativeai as genai

          # è®€å–ç’°å¢ƒè®Šæ•¸
          api_key = os.getenv("GOOGLE_API_KEY")
          pr_title = os.getenv("PR_TITLE", "")
          pr_body = os.getenv("PR_BODY", "")

          if not api_key:
              raise ValueError("API Key æœªè¨­å®šï¼Œè«‹æª¢æŸ¥ GitHub Secrets")

          # è®€å–æ¸¬è©¦æ¨™ç±¤ YAML æª”æ¡ˆ
          try:
              with open('.github/data/test_tags.yaml', 'r') as file:
                  tags_data = yaml.safe_load(file)
              # å°‡æ¨™ç±¤åˆ—è¡¨è½‰æ›ç‚ºé€—è™Ÿåˆ†éš”çš„å­—ç¬¦ä¸²
              available_tags = ", ".join(tags_data.get('tags', []))
          except Exception as e:
              print(f"è®€å–æ¨™ç±¤æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
              available_tags = "livestream, settings, following, login, register"  # é è¨­æ¨™ç±¤ï¼Œä»¥é˜²æª”æ¡ˆè®€å–å¤±æ•—

          # åˆå§‹åŒ– Google GenAI å®¢æˆ¶ç«¯
          genai.configure(api_key=api_key)

          # ç”Ÿæˆ AI åˆ†æžå…§å®¹
          prompt = f"""
          ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è»Ÿé«”æ¸¬è©¦å°ˆå®¶ï¼Œè«‹æ ¹æ“šä»¥ä¸‹ PR æ¨™é¡Œå’Œæè¿°ï¼Œä»¥åŠæ¸¬è©¦æä¾›çš„ç¾æœ‰ Tagsï¼Œæä¾›ç¬¦åˆå…§å®¹çš„è‡ªå‹•åŒ–æ¸¬è©¦Tagsï¼Œä¸¦å¯«æˆ TEST_RANGEï¼šlogin, register ...etc

          PR æ¨™é¡Œ: {pr_title}
          PR å…§æ–‡: {pr_body}

          å¯ç”¨çš„æ¸¬è©¦ Tags: {available_tags}
          """

          try:
              # ä½¿ç”¨ gemini-2.0-flash æ¨¡åž‹ç”Ÿæˆå…§å®¹
              model = genai.GenerativeModel(model_name="gemini-2.0-flash")
              response = model.generate_content(
                  prompt,
                  generation_config=genai.GenerationConfig(
                      temperature=0.2,
                      top_p=0.7,
                      max_output_tokens=1024
                  )
              )
              
              # æ“·å– AI å»ºè­°
              suggestions = response.text
              
              # å„²å­˜åˆ°æª”æ¡ˆ
              with open("ai_suggestions.txt", "w", encoding="utf-8") as f:
                  f.write(f"ðŸš€ **AI æ¸¬è©¦å»ºè­°**\n{suggestions}")
              
          except Exception as e:
              print(f"ç”Ÿæˆå…§å®¹æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
              sys.exit(1)
          EOF
          
      - name: Run AI Analysis
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: python .github/scripts/Ai_run.py
        
      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh pr comment ${{ github.event.pull_request.number }} --body "$(cat ai_suggestions.txt)"